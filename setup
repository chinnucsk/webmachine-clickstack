# -*-shell-script-*-

# Install everything from pkg_dir
cp -a $pkg_dir/* $app_dir/


# Create a start script that runs Python's SimpleHTTPServer (this will
# serve the directory contents over HTTP on $app_port)

cat > "$control_dir/start" << EOF
#!/bin/sh
cd $app_dir
export WEBMACHINE_PORT=$app_port
export $(cat $app_dir/.genapp/control/env)
exec ./start.sh
EOF

# start must be executable
chmod 755 "$control_dir/start"
chmod 755 "$app_dir/start.sh"

cd $app_dir

## patch up webmachine 

# remove reloader for deployment
$plugin_dir/replace.erl $app_dir/start.sh "reloader -s" " "

SUP_SRC_FILE=$app_dir/$(ls $app_dir/src/*_sup.erl)

# now add in port
$plugin_dir/replace.erl $SUP_SRC_FILE "{port, 8000}" "os:getenv(\"WEBMACHINE_PORT\")"

# change to not use code:priv_dir    
PRIV="filename:join(filename:dirname(filename:dirname(code:which(App))), \"priv\")"
./replace.erl $SUP_SRC_FILE "code:priv_dir(App)" $PRIV

# compile the app, removing any existing beam files

rm $app_dir/ebin/*.beam
find $app_dir/deps/ -type f -name *.beam | xargs rm
make
